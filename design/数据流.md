# 数据流设计


## openapi / swagger同步
- 解析openapi,swagger接口格式
    - 写入到`lct_api_meta`,产生一条api记录
        - url  `接口地址`
        - header `请求头`
        - method `请求方法`
        - body `请求参数`
        - query `url参数`
        - tags `api标签`
        - descption `api描述`

## 工作流配置
- 工作流配置数据
```yaml
# 接口自动化工作流描述文件
workflowName: 工作流名称(场景名称)
owner: 创建人
tags: 业务线1,模块1
config:
    timeout: 30 # 单位: 分钟
# data: 关联的的数据id
type: workflow
wfNodes:
- apiName: 节点名称
  apiId: 接口ID
  config:
    retry: 5
    timeout: 5000
  expect:
  - fieldName: 要断言的字段
    desireValue: 预期结果
    operation: 操作(include,equal,lt,gt,let,gte,noeqlual)
  dependency:
    # 需要用到哪个工作流的哪个节点的数据
  - nodeName: flow1.api1
    # 节点extract的字段名称
    extractName: token_type
    fieldName: type=external时指定，测试数据里面的字段，可以嵌套
    dataSourceType:  external / currentWF / runtimeWF
    inject:
      part: header / body / url
      location: Authorization / registInfo.reportno / taskId
  extract:
  - name: 111
    value: 111
- apiName: apiName
  apiId: "https"
  config:
    retry: 5
    timeout: 5000
  dependency:
  extract:
```

- 解析工作流配置文件
    - 转换成json
    - 根据expect，extract字段，生成记录写入到`lct_workflow_dependency`,`lct_workflow_expect`
    - `lct_workflow_info`表中添加一条记录,关联dependency_id,expect_id


## 数据生成规则配置
- 解析规则配置文件
    - 转换成json
    - `lct_workflow_data_rule`表这种添加一条记录
```yaml
---
# 接口参数规则文件
workflowID: 关联的工作流ID
workflowName: 工作流名称
description: 规则描述
- apiName: /start
  rules:
    - part: body
      ruleDetail:
      - name: username
        dataType: string
        condType: randomString
        cond:
          length:
            minLength: 5
            maxLength: 10
          charType: "01,02,03,04"
      - name: userType
        dataType: string
        condType: enum
        cond:
          enum:
            - regist
            - check
            - defloss
      - name: userNo
        dataType: number
        condType: randomNumber
        cond:
          minValue: 0
          maxValue: 1000
      - name: userNameList
        dataType: array
        condType: randomList
        cond:
          elementType: string / number / boolean
          length: 10
        # type=string时指定
          charRange: "01,02,03,04"
        # type=number时指定
          numberList: "0,1000"
      - name: time
        dataType: string
        condType: time
        cond:
          isCurrent: true
          date: "2020-01-01" 
      - name: db_date
        dataType: any
        condType: db
        cond:
          table: db.table1
          sql: ""  
    - part: url
      ruleDetail:
      - name: taskId
        dataType: string
        condType: randomString
        cond:
          length:
            minLength: 5
            maxLength: 10
          charType: "01,02,03,04"
```

## 生成工作流和测试数据
- 拉取`lct_workflow_info`表的全量数据，遍历每条数据
    - 根据workflowID去`lct_workflow_rule_data`中找到相对应的数据规则，生成测试数据写入到`lct_workflow_data`，返回dataID
    - 遍历workflow的所有节点
        - 根据apiID在`lct_api_meta`中获取api的信息，生成工作流详情对象(workflow_detail),包含以下信息
            - config
            - tags
            - dataID
            - wfNodes
                - apiURL
                - method
                - body
                - headers
                - extract
                - externalData
                - expect
        - 解析`expect`字段，根据id去`lct_workflow_expect`中找到对应的断言数据，并填写进workflow_detail.expect中
        - 解析`dependency`字段，根据依赖的来源类型（外部测试数据/上游接口/其他工作流接口），生成api的body，url，header数据的参数化，并填写进`workfow_detail.apiURL`,`workfow_detail.headers`,`workfow_detail.body`中
        - 解析`extract`字段，根据id去`lct_workflow_dependency`中找到对应的输出数据， 并填写进workfow_detail.extract中
    - 将dataID写入到workflow_detail.dataID中,将workflow和testdata关联
    - 根据tag字段的值，查找`lct_tag_info`数据，组合成{tagName, tagID}添加到workflow_detail.tags中
    - 将workflow_detail对象写入到`lct_workflow_detail`表中

## 创建一条测试任务
- 新增任务会往`lct_task_info`新增一条数据，新增时需指定以下字段
    - 标签: 业务线标签，模块标签
    - 运行环境
    - 是否自动运行

## 执行测试任务
- 全量执行
    - 执行配置的所有任务，通过一个`reportID`关联所有任务的运行记录
    - 结果写入到`lct_report`中
- 执行单个任务
    - 根据标签去`lct_workflow_detail`表中到到关联的对应workflow，然后传递给执行器执行，运行的结果写入到`lct_report`中